<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<title>LabBot AI Assistant</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>

<body>

<div class="app">

<div class="header">
    <div class="logo">ü§ñ LabBot</div>

    <div class="nav-modes">
        <button id="learnModeBtn" class="mode-btn active" onclick="switchMode('learn')">üìò Learning</button>
        <button id="interviewModeBtn" class="mode-btn" onclick="switchMode('interview')">üéì Interview</button>
    </div>

    <div class="status">
        <span id="modeStatus">Learning Mode</span>
        <span id="timer" style="margin-left:12px; display:none;">‚è± 05:00</span>
    </div>
</div>


<!-- FIX: chat stays INSIDE app -->
<div class="chat-container" id="chatBox">
    <div class="welcome">
        <div class="ai-avatar"></div>
        <div class="welcome-text">
        </div>
    </div>
</div>


<div class="input-panel">
    <button class="mic-btn" onclick="startVoice()">üé§</button>
    <input id="questionInput" placeholder="Ask a concept..." autocomplete="off">
    <button id="askBtn" class="send-btn" onclick="askQuestion()">Ask</button>
</div>

</div>

<div class="bg-glow"></div>

<script>

let currentMode="learn";
let interviewActive=false;

let voiceUnlocked = false;
let selectedVoice = null;
let speaking = false;

let interviewTimer = null;
let remainingTime = 300; // 5 minutes
let learningChatHTML = "";
let interviewChatHTML = "";
function finishInterview(finalScore=null){

    interviewActive = false;
    stopInterviewTimer();
    setModeLock(false);

    document.getElementById("modeStatus").innerText = "Interview Completed";

    // Disable submit button after completion
    document.getElementById("askBtn").disabled = true;
    document.getElementById("questionInput").disabled = true;

    if(finalScore !== null){
        showFinalReport(finalScore);
    } else {
        addMessage("üèÅ Interview Finished","bot");
    }
}
function setModeLock(lock){

    const learnBtn = document.getElementById("learnModeBtn");

    if(lock){
        learnBtn.disabled = true;
        learnBtn.style.opacity = "0.5";
        learnBtn.style.cursor = "not-allowed";
    }
    else{
        learnBtn.disabled = false;
        learnBtn.style.opacity = "1";
        learnBtn.style.cursor = "pointer";
    }
}

/* ================= INTERVIEW TIMER ================= */

function startInterviewTimer(){

    remainingTime = 40;
    document.getElementById("timer").style.display = "inline";

    updateTimerUI();

    interviewTimer = setInterval(async ()=>{

    try{
        const res = await fetch("/presence_status");
        const data = await res.json();

        if(!data.present){
            document.getElementById("modeStatus").innerText = "Interview Paused (No Presence)";
            return; // Do NOT decrement timer
        }

        document.getElementById("modeStatus").innerText = "Interview Mode";

        remainingTime--;
        updateTimerUI();

        if(remainingTime <= 0){
            clearInterval(interviewTimer);
            endInterviewByTime();
        }

    }catch(e){
        console.log("Presence check error");
    }

},1000);
}

function updateTimerUI(){
    const min = String(Math.floor(remainingTime/60)).padStart(2,'0');
    const sec = String(remainingTime%60).padStart(2,'0');
    document.getElementById("timer").innerText = `‚è± ${min}:${sec}`;
}

function stopInterviewTimer(){
    clearInterval(interviewTimer);
    document.getElementById("timer").style.display = "none";
}
/* ---------------- MODE SWITCH ---------------- */

function switchMode(mode){

    if(mode === currentMode) return;

    const chatBox = document.getElementById("chatBox");

    if(currentMode === "learn"){
        learningChatHTML = chatBox.innerHTML;
    }

    document.getElementById("learnModeBtn").classList.toggle("active",mode==="learn");
    document.getElementById("interviewModeBtn").classList.toggle("active",mode==="interview");

    currentMode = mode;

    if(mode === "learn"){

        chatBox.innerHTML = learningChatHTML || `
            <div class="welcome">
                <div class="ai-avatar"></div>
                <div class="welcome-text"></div>
            </div>
        `;

        enterLearningMode();
    }
    else{

        chatBox.innerHTML = "";
        enterInterviewMode();
    }
}
function unlockVoice(){

    if(!window.speechSynthesis) return;

    // load voices
    speechSynthesis.getVoices();

    // dummy speak to activate audio permission
    const dummy = new SpeechSynthesisUtterance("");
    speechSynthesis.speak(dummy);
    speechSynthesis.cancel();

    setTimeout(()=>{
        const voices = speechSynthesis.getVoices();
        selectedVoice =
            voices.find(v=>v.lang.includes("en-IN")) ||
            voices.find(v=>v.lang.includes("en-US")) ||
            voices[0];

        voiceUnlocked = true;
        console.log("Voice Ready");
    },120);
}
/* ---------------- ASK ---------------- */

async function askQuestion(){

    const input=document.getElementById("questionInput");
    const text=input.value.trim();
    if(!text) return;

    addMessage(text,"user");
    input.value="";

    /* INTERVIEW MODE */
    if(currentMode==="interview" && interviewActive){
        await submitInterviewAnswer(text);
        return;
    }

    try{
        showTyping();

        const res=await fetch("/ask",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({question:text})
        });

        if(!res.ok){
            throw new Error("Server returned "+res.status);
        }

        const data=await res.json();

        removeTyping();

        if(!data || !data.answer){
            addMessage("‚ö† No answer received from server","bot");
            return;
        }

        addBotConcept(data.answer);
        speakAnswer(cleanForSpeech(data.answer));

    }catch(err){
        console.error("ASK ERROR:",err);
        removeTyping();
        addMessage("‚ö† Server not responding. Please retry.","bot");
    }
}
/* ---------------- CLEAN SPEECH ---------------- */

function cleanForSpeech(text){
    return text
        .replace(/\[From.*?\]/gi,"")
        .replace(/\[.*?LEVEL.*?\]/gi,"")
        .replace(/‚Ä¢/g,"")
        .trim();
}

/* ---------------- INTERVIEW ---------------- */

async function enterInterviewMode(){
    if(interviewActive) return;
    const res=await fetch("/start_interview");
    const data=await res.json();

    if(!data.question){
        addMessage("No interview questions available","bot");
        return;
    }

    interviewActive=true;
    document.getElementById("askBtn").disabled = false;
    document.getElementById("questionInput").disabled = false;
    document.getElementById("modeStatus").innerText="Interview Mode";
    document.getElementById("askBtn").innerText="Submit";
    document.getElementById("questionInput").placeholder="Type your answer...";

    addMessage("üéì Interview Started","bot");
    addInterviewQuestion(data.question);
    setModeLock(true);
    startInterviewTimer();
}

async function submitInterviewAnswer(answer){

    showTyping();

    const res=await fetch("/evaluate",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({answer})
    });

    const data=await res.json();

    removeTyping();

    addMessage(`Score: ${data.score}%\n${data.feedback}`,"bot");

if(data.next !== null && data.next !== undefined){
    addInterviewQuestion(data.next);
    } 
else {
    finishInterview(data.final_score);
    }
}
/* ---------------- LEARNING MODE ---------------- */

function enterLearningMode(){

    interviewActive = false;

    // Re-enable input & button
    document.getElementById("askBtn").disabled = false;
    document.getElementById("questionInput").disabled = false;

    document.getElementById("modeStatus").innerText="Learning Mode";
    document.getElementById("askBtn").innerText="Ask";
    document.getElementById("questionInput").placeholder="Ask a concept...";

    setModeLock(false);
}
/* ---------------- VOICE ---------------- */

document.body.addEventListener("click",()=>{
    const voices=speechSynthesis.getVoices();
    selectedVoice=voices.find(v=>v.lang.includes("en-IN")) || voices[0];
},{once:true});


function speakAnswer(text){

    if(!voiceUnlocked) return;

    text = cleanForSpeech(text);

    const assistant = document.getElementById("ai-assistant");
    const robot = document.getElementById("ai-robot");
    const bubble = document.getElementById("ai-bubble");

    function speakNow(){

        const utter = new SpeechSynthesisUtterance(text);
        utter.voice = selectedVoice || speechSynthesis.getVoices()[0];
        utter.rate = 1;
        utter.pitch = 1;
        utter.volume = 1;

        speaking = true;

        // Show assistant
        assistant.style.display = "flex";
        assistant.style.transform = "translateY(20px)";
        setTimeout(() => {
            assistant.style.opacity = "1";
            assistant.style.transform = "translateY(0)";
        }, 50);

        bubble.innerText = text.slice(0, 90) + "...";
        bubble.style.opacity = "1";

        assistant.classList.add("ai-speaking");

        utter.onend = ()=>{
            speaking = false;
            assistant.classList.remove("ai-speaking");

            setTimeout(()=>{
                bubble.style.opacity = "0";
                assistant.style.opacity = "0";
                setTimeout(()=>{
                    assistant.style.display = "none";
                },400);
            },800);
        };

        utter.onerror = ()=>{
            speaking = false;
            assistant.classList.remove("ai-speaking");
        };

        speechSynthesis.cancel();
        speechSynthesis.speak(utter);
    }

    setTimeout(()=>{
        if(speechSynthesis.getVoices().length===0){
            speechSynthesis.onvoiceschanged = ()=> speakNow();
        }else{
            speakNow();
        }
    },120);
}
/* ---------------- UI ---------------- */

function addMessage(text,type){
    const chat=document.getElementById("chatBox");
    const wrapper=document.createElement("div");
    wrapper.className="msg-wrapper "+type;
    const msg=document.createElement("div");
    msg.className="msg "+type;
    msg.textContent=text;
    wrapper.appendChild(msg);
    chat.appendChild(wrapper);
    chat.scrollTop=chat.scrollHeight;
}
function addBotConcept(text){

    const chat=document.getElementById("chatBox");

    let subject="GENERAL";
    let subjectMatch=text.match(/\[From (.*?)\]/i);
    if(subjectMatch){
        subject=subjectMatch[1];
        text=text.replace(subjectMatch[0],"").trim();
    }

    const wrapper=document.createElement("div");
    wrapper.className="msg-wrapper bot";

    const card=document.createElement("div");
    card.className="msg bot concept-card";

    let lines=text.split("\n").filter(l=>l.trim()!=="");

    let title=lines.shift() || "";
    let definition=lines.shift() || "";
    let points=lines;

    let html=`
        <div class="subject-badge">${subject}</div>
        <div class="concept-title">${title}</div>
        <div class="concept-def">${definition}</div>
    `;

    if(points.length){
        html+=`<div class="concept-points">`;
        points.forEach(p=>{
            html+=`<div class="point">‚Ä¢ ${p}</div>`;
        });
        html+=`</div>`;
    }

    card.innerHTML=html;

    wrapper.appendChild(card);
    chat.appendChild(wrapper);
    chat.scrollTop=chat.scrollHeight;
}
function showTyping(){
    removeTyping();
    const div=document.createElement("div");
    div.id="typing";
    div.className="typing-bubble";
    div.innerHTML=`<span></span><span></span><span></span>`;
    document.getElementById("chatBox").appendChild(div);
}

function removeTyping(){
    const t=document.getElementById("typing");
    if(t) t.remove();
}
function addInterviewQuestion(text){

    const chat=document.getElementById("chatBox");

    const wrapper=document.createElement("div");
    wrapper.className="msg-wrapper bot";

    const card=document.createElement("div");
    card.className="msg bot interview-card";

    card.innerHTML = `
        <div class="interview-label">üéì Interview Question</div>
        <div class="interview-text">${text}</div>
    `;

    wrapper.appendChild(card);
    chat.appendChild(wrapper);
    chat.scrollTop=chat.scrollHeight;
}

function showFinalReport(score){

    const chat=document.getElementById("chatBox");

    const wrapper=document.createElement("div");
    wrapper.className="msg-wrapper bot";

    const card=document.createElement("div");
    card.className="msg bot final-report";

    let grade = "Needs Improvement";
    if(score >= 75) grade = "Excellent";
    else if(score >= 50) grade = "Good";

    card.innerHTML = `
        <div class="report-title">üéì Final Evaluation Report</div>
        <div class="report-score">Score: ${score}%</div>
        <div class="report-grade">Grade: ${grade}</div>
        <div class="report-bar">
            <div class="report-fill" style="width:${score}%"></div>
        </div>
    `;

    wrapper.appendChild(card);
    chat.appendChild(wrapper);
    chat.scrollTop=chat.scrollHeight;
}
/* ---------------- MIC ---------------- */

function startVoice(){

    if(!('webkitSpeechRecognition' in window)){
        alert("Voice not supported");
        return;
    }

    const mic=document.querySelector(".mic-btn");
    mic.classList.add("recording");

    const rec=new webkitSpeechRecognition();
    rec.lang="en-US";
    rec.start();

    rec.onresult=e=>{
        document.getElementById("questionInput").value=e.results[0][0].transcript;
    };

    rec.onend=()=>mic.classList.remove("recording");
    rec.onerror=()=>mic.classList.remove("recording");
}

async function endInterviewByTime(){

    addMessage("‚è∞ Time is up! Finishing interview...","bot");

    try{
        const res = await fetch("/evaluate",{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({answer:""})
        });

        const data = await res.json();
        finishInterview(data.final_score);

    }catch(e){
        finishInterview();
    }
}document.body.addEventListener("click", unlockVoice, { once:true });
</script>
<!-- ü§ñ LabBot Assistant -->
<div id="ai-assistant">
    <img src="{{ url_for('static', filename='robo.png') }}" id="ai-robot">
    <div id="ai-bubble"></div>
</div>
</body>
</html>
